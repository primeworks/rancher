| multisearch 

[ search index="sfx" source="/opt/splunk/var/sfx-data/sfx-invoices/SHELL*.csv" Unit != "*Andy*" AND Unit != "*Jonath*" AND Unit != "*Steph*" 
| rename Amt as Price, "State_ Prov" as Province, "Location Name" as Location, Qty as Quantity, "Unit Price" as Cost, "Tran Date" as TranDate, "Tran Time" as TranTime, "Item" as Description
| eval Provider="Shell", Date=strftime(_time, "%y-%m-%d"), DateTime=TranDate +" "+ TranTime 
| fields Unit, Provider, Card, Price, Province, City, Location, Date, Quantity, Cost, Country, DateTime, Description ] 

[ search index="sfx" source="/opt/splunk/var/sfx-data/sfx-invoices/FLYINGJ*.csv"
| rename Amt as Price, "State_ Prov" as Province, "Location Name" as Location, Qty as Quantity, "Unit Price" as Cost, "Tran Date" as TranDate, "Tran Time" as TranTime, "Item" as Description 
| eval Provider="Flying J", Date=strftime(_time, "%y-%m-%d"), DateTime=TranDate +" "+ TranTime 
| fields Unit, Provider, Card, Price, Province, City, Location, Date, Quantity, Cost, Country, DateTime, Description ]

[ search index="sfx" source="/opt/splunk/var/sfx-data/sfx-invoices/IRVING*.csv"
| rename Amt as Price, "State_ Prov" as Province, "Location Name" as Location, Qty as Quantity, "Unit Price" as Cost, "Tran Date" as TranDate, "Tran Time" as TranTime, "Item" as Description 
| eval Provider="Irving", Date=strftime(_time, "%y-%m-%d"), DateTime=TranDate +" "+ TranTime 
| fields Unit, Provider, Card, Price, Province, City, Location, Date, Quantity, Cost, Country, DateTime, Description ]

[ search index="sfx" source="/opt/splunk/var/sfx-data/sfx-invoices/BVD*.csv" UOM="L"
| rename "Driver Id" as Unit
| eval Provider="BVD", Date=strftime(_time, "%y-%m-%d"), DateTime=Date +" "+ Time, pCost=Cost
| rename "PreTax AMT" as Price, "Prov_ST Abb" as Province, "Site City" as City, "Site" as Location, "Billed PPU" as Cost, "Fuel Code" as Description
| fields Unit, Provider, Card, Price, Province, City, Location, Date, Quantity, Cost, Country, DateTime, Description ]

[ search index="sfx" source="/opt/splunk/var/sfx-data/sfx-invoices/BVD*.csv" UOM="L" City="CORNWALL"
| eval Provider="BVD", Date=strftime(_time, "%y-%m-%d"), DateTime=Date +" "+ Time
| rename "Billed PPU" as pCost
| fields pCost ]

[ search index="sfx" source="/opt/splunk/var/sfx-data/sfx-invoices/BVD*.csv" UOM="G"
| rename "Driver Id" as Unit, "PreTax AMT" as Price, "Prov_ST Abb" as Province, "Site City" as City, "Site" as Location, "Billed PPU" as Cost, "Exchange Rate" as exchange, "Fuel Code" as Description
| eval Provider="Loves", Date=strftime(_time, "%y-%m-%d"), Gallons=sum(Quantity), volume-g=Gallons*3.78541, Quantity=Quantity*3.78541, DateTime=Date +" "+ Time 
| fields Unit, Provider, Card, Price, Province, City, Location, Date, Quantity, Cost, exchange, exr, Country, DateTime, Description ]

[ search index="sfx" source="/opt/splunk/var/sfx-data/sfx-invoices/PIPELINE*.csv"
| eval Cost=(Montant/Quantit)
| lookup "pipeline-cards" "Card number" as "No Carte" OUTPUT Unit
| rename Montant as Price, Prov as Province, "Description site" as City, Quantit as Quantity, "Date trans" as DateTime, "No Carte" as Card, "Produit" as Description 
| eval Provider="Pipeline", Date=strftime(_time, "%y-%m-%d")
| fields Provider, Cost, Card, Price, Province, City, Location, Date, Quantity, Country, DateTime, Description, Unit ]


| eval Date=strftime(_time, "%y-%m-%d"), Gallons=Quantity/3.785, Compliant=case(City="MONCTON", "Yes", City="WOODSTOCK*", "Yes", City="HOULTON", "Yes", City="AULAC", "Yes", City="ENFIELD", "Yes", City="Bordentown", "Yes", City="Binghamton", "Yes", City="WILLINGTON", "Yes", City="NIAGARA", "Yes", City="MILTON", "Yes", City="MISSISSAUGA", "Yes", City="BRAMPTON", "Yes", City="KINGSTON", "Yes", City="CORNWALL", "Yes", City="STE JULIE", "Yes", City="WOODSTOCK FIRST NATION", "Yes", City="EDMUNDSTON", "Yes", City="BEARDSLEY", "Yes", City="KITCHENER", "Yes"), Country=case(Province="ON", "Canada", Province="NB", "Canada", Province="PE", "Canada", Province="SK", "Canada", Province="AB", "Canada", Province="BC", "Canada", Province="MB", "Canada", Province="NS", "Canada", Province="QC", "Canada", Province="NL", "Canada", Province="YT", "Canada", Province="NT", "Canada", Province="NU", "Canada"), Cost=if('Provider' = "Loves", (((Cost/3.78451)*$exrt$)+1.50000), 'Cost'), oQuantity=((Quantity/3.785)-50), Diff=((Cost-$cacost$)*(Quantity-190)), Gallons=(Quantity/3.785)

| rex field=Unit "(?<Unit>\d{3})"
| lookup "driver_list" "Notes" as "Unit" OUTPUT "Name"
| lookup "driver_list" "Notes" as "Unit" OUTPUT "Phone 1 - Value"
| rename "Name" as Driver, "Phone 1 - Value" as Phone, Diff as Overage, oQuantity as Spillover
| fillnull value="No" Compliant 
| fillnull value="United States" Country
| fields Provider, Cost, Card, Price, Province, City, Location, Date, Quantity, Country, DateTime, Description, Unit, Compliant, Gallons, Overage, Spillover, Phone, Driver
| search Quantity > 0.0 Provider="$prov$" City="$cit$" Compliant="$compliant$" Unit="$uni$" Province="$provin$" Country="$country$"
| sort - DateTime
